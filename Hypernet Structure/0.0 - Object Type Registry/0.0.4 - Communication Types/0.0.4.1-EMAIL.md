# EMAIL - Email Messages with Threading Object Type

**Type ID:** `hypernet.communication.email`
**Version:** 1.0
**Category:** 0.0.4 - Communication Types
**Parent:** BaseObject
**Status:** Active - Core Communication Type
**Created:** 2026-02-09
**Last Updated:** 2026-02-09

---

## Object Type Metadata

```yaml
type_name: "Email"
type_id: "hypernet.communication.email"
version: "1.0"
parent_type: "BaseObject"
category: "0.0.4 - Communication Types"
abstract: false
instantiable: true
```

---

## Purpose and Description

### What is Email?

The Email object type represents email messages imported from any email provider (Gmail, Outlook, iCloud, etc.) or sent/received through Hypernet. Emails are first-class objects with full support for threading, attachments, recipients, and rich metadata. This enables unified email management across all accounts and providers.

### Revolutionary Design Philosophy

Hypernet treats email as structured communication data, not locked-in proprietary formats:
- **Provider Agnostic** - Emails from Gmail, Outlook, Yahoo, or any IMAP/POP3 provider use the same schema
- **Thread-Aware** - Native support for conversation threading with parent-child relationships
- **Attachment Management** - Attachments become Media objects, enabling deduplication and organization
- **Full-Text Searchable** - Search across all email accounts simultaneously
- **Privacy Preserved** - End-to-end encryption for sensitive emails
- **AI Enhanced** - Smart categorization, sentiment analysis, action item extraction

### Core Functions

1. **Email Storage** - Store complete email messages with headers, body, and metadata
2. **Thread Management** - Organize emails into conversations with proper threading
3. **Attachment Handling** - Extract and store attachments as Media objects
4. **Contact Extraction** - Automatically create Contact objects from recipients
5. **Search and Filter** - Full-text search, advanced filters, smart categorization
6. **Sync Management** - Bidirectional sync with email providers (IMAP/SMTP)
7. **Action Items** - AI-powered detection of tasks, events, and follow-ups

### When to Use

- Importing email archives from Gmail, Outlook, Apple Mail, etc.
- Sending and receiving emails through Hypernet
- Managing multiple email accounts in one unified interface
- Searching across all email history
- Extracting attachments for unified media management
- Tracking conversations and threads
- AI-powered email organization and prioritization

---

## Inherited Fields from BaseObject

```yaml
id: UUID
  - Globally unique email identifier
  - Generated on import or creation
  - Immutable

created_at: DateTime
  - Import timestamp (when added to Hypernet)
  - May differ from sent_at (original send time)
  - Immutable

updated_at: DateTime
  - Last modification timestamp
  - Updated when email is moved, labeled, or metadata changes

deleted_at: DateTime (nullable)
  - Soft delete timestamp
  - Null for active emails
  - Emails in trash for 30 days before hard delete

user_id: UUID
  - Foreign key to User who owns this email
  - Required - all emails must have an owner
  - Determines which account's mailbox this belongs to

metadata: JSONB
  - Extensible metadata storage
  - See Metadata Schema section below
  - Stores provider-specific data, headers, flags
```

---

## Required Fields

### Message Identification

```yaml
message_id: String(500)
  type: String
  max_length: 500
  nullable: false
  indexed: true
  unique: true (per user)
  description: "RFC 5322 Message-ID from email headers"
  format: "<unique-id@domain.com>"
  examples:
    - "<CAGFj3YmZ9x@mail.gmail.com>"
    - "<abc123.def456@outlook.com>"
  purpose: "Deduplication, thread matching, sync reconciliation"
  constraints:
    - Must be globally unique per user
    - Used to prevent duplicate imports
    - Required for IMAP/SMTP compliance

subject: String(1000)
  type: String
  max_length: 1000
  nullable: false
  indexed: true
  description: "Email subject line"
  examples:
    - "Re: Q4 Budget Review"
    - "Vacation Photos"
    - "Meeting Tomorrow at 2pm"
  searchable: true
  constraints:
    - Empty string allowed (for emails without subject)
    - Truncated if exceeds max_length
    - Preserved exactly as received

sent_at: DateTime
  type: DateTime
  nullable: false
  indexed: true
  timezone: true
  description: "When the email was sent (from Date header)"
  sources:
    - Email Date header (RFC 5322)
    - SMTP envelope timestamp
  usage: "Primary field for chronological ordering"
  constraints:
    - Must be valid timestamp
    - Can be in past or future
    - Used for thread sorting
```

### Message Content

```yaml
body_text: Text
  type: Text
  nullable: true
  description: "Plain text version of email body"
  extraction:
    - From text/plain MIME part
    - Converted from HTML if text not available
  searchable: true
  constraints:
    - Can be empty for HTML-only emails
    - UTF-8 encoded
    - Line breaks preserved

body_html: Text
  type: Text
  nullable: true
  description: "HTML version of email body"
  extraction:
    - From text/html MIME part
    - Sanitized for security (XSS prevention)
  usage: "Rich email rendering in UI"
  constraints:
    - Can be empty for text-only emails
    - HTML sanitized before storage
    - External images tracked separately

has_attachments: Boolean
  type: Boolean
  nullable: false
  default: false
  indexed: true
  description: "Whether email has file attachments"
  derivation: "Set to true if attachment_count > 0"
  usage: "Quick filtering for emails with attachments"
```

### Sender and Recipients

```yaml
from_address: String(500)
  type: String
  max_length: 500
  nullable: false
  indexed: true
  description: "Sender's email address"
  format: "email@domain.com or 'Name <email@domain.com>'"
  examples:
    - "john.doe@example.com"
    - "Jane Smith <jane@company.com>"
  searchable: true
  constraints:
    - Must be valid email format
    - Display name optional
    - Used for sender filtering

from_name: String(500)
  type: String
  max_length: 500
  nullable: true
  description: "Sender's display name"
  examples:
    - "John Doe"
    - "Marketing Team"
  extraction: "Parsed from From header display name"
  searchable: true

to_addresses: JSONB
  type: JSONB
  nullable: false
  default: []
  indexed: true (GIN)
  description: "Array of recipient email addresses (To: header)"
  structure: ["email1@domain.com", "email2@domain.com"]
  examples:
    - ["alice@example.com", "bob@example.com"]
  searchable: true
  constraints:
    - Each address must be valid email format
    - Array can be empty (for draft emails)

cc_addresses: JSONB
  type: JSONB
  nullable: false
  default: []
  indexed: true (GIN)
  description: "Array of CC recipient email addresses"
  structure: ["email1@domain.com", "email2@domain.com"]
  usage: "Carbon copy recipients"

bcc_addresses: JSONB
  type: JSONB
  nullable: false
  default: []
  description: "Array of BCC recipient email addresses"
  structure: ["email1@domain.com", "email2@domain.com"]
  usage: "Blind carbon copy recipients (only visible to sender)"
  privacy: "Not visible in received emails"
```

---

## Optional Fields

### Threading and Conversation

```yaml
thread_id: String(500)
  type: String
  max_length: 500
  nullable: true
  indexed: true
  description: "Conversation thread identifier"
  sources:
    - Gmail X-GM-THRID header
    - References/In-Reply-To headers
    - Subject-based matching
  purpose: "Group related emails into conversations"
  usage: "Display emails in threaded view"

in_reply_to: String(500)
  type: String
  max_length: 500
  nullable: true
  indexed: true
  description: "Message-ID of email this is replying to"
  format: "<message-id@domain.com>"
  purpose: "Build parent-child email relationships"
  usage: "Thread reconstruction"

references: JSONB
  type: JSONB
  nullable: true
  description: "Array of Message-IDs this email references"
  structure: ["<msg1@domain.com>", "<msg2@domain.com>"]
  purpose: "Complete thread ancestry tracking"
  sources: "References header (RFC 5322)"

parent_email_id: UUID
  type: UUID
  nullable: true
  indexed: true
  description: "Foreign key to parent Email object"
  references: "Email.id"
  cascade: "ON DELETE SET NULL"
  purpose: "Direct parent-child relationship in thread"
  usage: "Display conversation hierarchy"
```

### Email Classification

```yaml
folder: String(200)
  type: String
  max_length: 200
  nullable: true
  indexed: true
  description: "Mailbox folder where email is stored"
  examples:
    - "INBOX"
    - "Sent"
    - "Archive"
    - "Work/Projects"
    - "[Gmail]/All Mail"
  sources:
    - IMAP folder path
    - User organization
  usage: "Folder-based filtering and organization"

labels: JSONB
  type: JSONB
  nullable: false
  default: []
  indexed: true (GIN)
  description: "Array of label/tag strings"
  structure: ["label1", "label2", "label3"]
  examples:
    - ["work", "urgent", "client-abc"]
    - ["personal", "family"]
  searchable: true
  sources:
    - Gmail labels
    - User-applied tags
    - AI categorization

is_read: Boolean
  type: Boolean
  nullable: false
  default: false
  indexed: true
  description: "Whether email has been read"
  usage: "Unread count, filtering"
  sync: "Synced with IMAP \Seen flag"

is_starred: Boolean
  type: Boolean
  nullable: false
  default: false
  indexed: true
  description: "Whether email is starred/flagged"
  usage: "Important email filtering"
  sync: "Synced with IMAP \Flagged"

is_important: Boolean
  type: Boolean
  nullable: false
  default: false
  indexed: true
  description: "Whether email is marked as important"
  sources:
    - Gmail importance markers
    - User manual marking
    - AI priority detection

priority: Enum
  type: String
  max_length: 20
  nullable: true
  indexed: true
  description: "Email priority level"
  allowed_values:
    - "high": Urgent, requires immediate attention
    - "normal": Standard priority
    - "low": Can be addressed later
  sources:
    - X-Priority header
    - Importance header
    - User setting
```

### Attachment Information

```yaml
attachment_count: Integer
  type: Integer
  nullable: false
  default: 0
  description: "Number of file attachments"
  constraints:
    - Must be >= 0
    - Auto-calculated from attachments relationship
  usage: "Quick attachment presence check"

total_attachment_size: BigInteger
  type: BigInteger
  nullable: false
  default: 0
  description: "Total size of all attachments in bytes"
  unit: "bytes"
  constraints:
    - Must be >= 0
    - Sum of all attachment file sizes
  usage: "Storage tracking, quota management"
```

### Source and Sync Information

```yaml
account_email: String(500)
  type: String
  max_length: 500
  nullable: true
  indexed: true
  description: "Email account this message belongs to"
  examples:
    - "user@gmail.com"
    - "john.doe@company.com"
  purpose: "Multi-account email management"
  usage: "Filter by account, display account badge"

provider: String(100)
  type: String
  max_length: 100
  nullable: true
  indexed: true
  description: "Email provider/service"
  allowed_values:
    - "gmail": Google Gmail
    - "outlook": Microsoft Outlook/Office 365
    - "icloud": Apple iCloud Mail
    - "yahoo": Yahoo Mail
    - "imap": Generic IMAP server
    - "exchange": Microsoft Exchange
  purpose: "Provider-specific features and sync"

integration_id: UUID
  type: UUID
  nullable: true
  indexed: true
  description: "Foreign key to Integration that synced this email"
  references: "Integration.id"
  cascade: "ON DELETE SET NULL"
  purpose: "Track which integration manages this email"

imap_uid: BigInteger
  type: BigInteger
  nullable: true
  indexed: true
  description: "IMAP UID for this message on server"
  purpose: "IMAP sync reconciliation"
  constraints:
    - Unique per folder per account
    - Used for efficient sync

smtp_message_id: String(500)
  type: String
  max_length: 500
  nullable: true
  description: "SMTP envelope Message-ID (may differ from header)"
  purpose: "Delivery tracking, bounce handling"
```

### Delivery and Receipt

```yaml
received_at: DateTime
  type: DateTime
  nullable: true
  indexed: true
  timezone: true
  description: "When email was received by server"
  sources: "Received header timestamp"
  usage: "Distinguish send time from receive time"

delivered_at: DateTime
  type: DateTime
  nullable: true
  timezone: true
  description: "When email was delivered to recipient (for sent emails)"
  sources: "SMTP delivery receipt"
  usage: "Track email delivery status"

read_at: DateTime
  type: DateTime
  nullable: true
  timezone: true
  description: "When email was first marked as read"
  usage: "Read receipt, response time analysis"
  privacy: "Not shared unless user enables read receipts"

bounce_status: String(50)
  type: String
  max_length: 50
  nullable: true
  description: "Bounce/delivery failure status"
  allowed_values:
    - "delivered": Successfully delivered
    - "bounced": Hard bounce (permanent failure)
    - "soft_bounce": Temporary failure
    - "spam": Marked as spam
  sources: "SMTP bounce messages, delivery receipts"
```

---

## Metadata Schema

The `metadata` JSONB field stores extensible email-specific and provider data:

```json
{
  "headers": {
    "received": [
      "from mail-server.example.com by mx.gmail.com",
      "from client.example.com by mail-server.example.com"
    ],
    "x-mailer": "Apple Mail (2.3654.60.0.1)",
    "x-original-sender": "original@example.com",
    "list-unsubscribe": "<mailto:unsubscribe@newsletter.com>",
    "authentication_results": "spf=pass smtp.mailfrom=example.com"
  },
  "provider": {
    "gmail": {
      "thread_id": "16f8a1b2c3d4e5f6",
      "message_id": "16f8a1b2c3d4e5f7",
      "labels": ["INBOX", "CATEGORY_PROMOTIONS", "UNREAD"],
      "snippet": "Email preview text...",
      "history_id": "123456"
    },
    "outlook": {
      "conversation_id": "AAQkAGY3...",
      "internet_message_id": "<abc@outlook.com>",
      "categories": ["Work", "Important"],
      "flag_status": "flagged"
    }
  },
  "ai_analysis": {
    "category": "newsletter",
    "sentiment": "neutral",
    "language": "en",
    "confidence": 0.95,
    "action_items": [
      {
        "action": "Review Q4 budget",
        "due_date": "2024-02-15",
        "confidence": 0.87
      }
    ],
    "entities": [
      {"type": "person", "name": "John Smith", "confidence": 0.92},
      {"type": "organization", "name": "Acme Corp", "confidence": 0.89},
      {"type": "date", "value": "2024-02-15", "confidence": 0.95}
    ],
    "summary": "Meeting request for Q4 budget review on Feb 15th",
    "key_points": [
      "Budget review meeting scheduled",
      "Attendance required from all department heads",
      "Preparation materials attached"
    ],
    "is_newsletter": true,
    "is_promotional": false,
    "is_transactional": false,
    "spam_score": 0.02
  },
  "security": {
    "spf_pass": true,
    "dkim_pass": true,
    "dmarc_pass": true,
    "is_encrypted": false,
    "is_signed": false,
    "virus_scan": "clean",
    "phishing_score": 0.01
  },
  "tracking": {
    "has_tracking_pixels": false,
    "has_tracking_links": true,
    "tracking_domains": ["track.newsletter.com"]
  },
  "rendering": {
    "stripped_html": false,
    "external_images_allowed": false,
    "css_sanitized": true
  }
}
```

---

## Relationships to Other Object Types

### Ownership and Integration

```yaml
owned_by: User
  description: "User who owns this email"
  cardinality: "N:1 (many emails, one owner)"
  implementation: "user_id foreign key"
  cascade: "ON DELETE CASCADE"

synced_by: Integration
  description: "Integration that synced this email"
  cardinality: "N:1 (many emails, one integration)"
  implementation: "integration_id foreign key"
  cascade: "ON DELETE SET NULL"
```

### Threading

```yaml
parent_email: Email
  description: "Email this is replying to"
  cardinality: "N:1 (many replies, one parent)"
  implementation: "parent_email_id foreign key"
  cascade: "ON DELETE SET NULL"
  usage: "Build conversation threads"

child_emails: Email
  description: "Emails that are replies to this one"
  cardinality: "1:N (one parent, many replies)"
  implementation: "Reverse relationship"
  usage: "Display conversation thread"

thread_emails: Email
  description: "All emails in same conversation thread"
  cardinality: "M:N (many emails, many threads)"
  implementation: "thread_id grouping"
  usage: "Display full conversation"
```

### Attachments

```yaml
attachments: Media
  description: "File attachments extracted from email"
  cardinality: "1:N (one email, many attachments)"
  link_type: "email_attachment"
  implementation: "Join table with ordering and filename"
  examples:
    - Email has PDF report, Excel spreadsheet, photo
  processing:
    - Attachments extracted and stored as Media objects
    - Original email preserves attachment metadata
    - Attachments can be deduplicated across emails
```

### Contacts

```yaml
from_contact: Contact
  description: "Contact object for sender"
  cardinality: "N:1 (many emails, one contact)"
  link_type: "email_from"
  implementation: "Auto-created from from_address"
  usage: "Contact management, sender filtering"

to_contacts: Contact
  description: "Contact objects for recipients"
  cardinality: "M:N (many emails, many contacts)"
  link_type: "email_to"
  implementation: "Auto-created from to_addresses"
  usage: "Recipient tracking, conversation history"
```

### Extracted Entities

```yaml
mentioned_people: Contact
  description: "People mentioned in email body"
  cardinality: "M:N (many emails, many people)"
  link_type: "mentioned_in"
  sources: "AI entity extraction"

referenced_events: CalendarEvent
  description: "Calendar events referenced in email"
  cardinality: "M:N (many emails, many events)"
  link_type: "references"
  sources: "AI event extraction, calendar invites"

generated_tasks: Task
  description: "Tasks created from email action items"
  cardinality: "1:N (one email, many tasks)"
  link_type: "derived_from"
  sources: "AI action item extraction, user creation"
```

---

## API Endpoints

### Email Retrieval

```http
GET /api/v1/emails/{id}
  Description: Get single email by ID
  Headers:
    Authorization: Bearer {access_token}
  Response: 200 OK
    {complete email object with attachments, thread info}
  Privacy:
    - Only owner can access
    - Returns 404 if not found or unauthorized

GET /api/v1/emails
  Description: List user's emails with filtering
  Headers:
    Authorization: Bearer {access_token}
  Query Parameters:
    account: user@gmail.com - Filter by email account
    folder: INBOX - Filter by folder
    label: work - Filter by label
    is_read: true|false - Filter by read status
    is_starred: true|false - Filter starred only
    has_attachments: true|false - Filter by attachments
    from: sender@example.com - Filter by sender
    to: recipient@example.com - Filter by recipient
    thread_id: {thread-id} - Get all emails in thread
    date_from: 2024-01-01
    date_to: 2024-12-31
    search: "query" - Full-text search
    limit: 50 (default: 50, max: 200)
    offset: 0
    sort: sent_at|received_at|subject (default: sent_at)
    order: asc|desc (default: desc)
  Response: 200 OK
    {
      "emails": [{email objects}],
      "total": 15234,
      "unread_count": 234,
      "limit": 50,
      "offset": 0
    }

GET /api/v1/emails/{id}/thread
  Description: Get complete conversation thread for email
  Headers:
    Authorization: Bearer {access_token}
  Response: 200 OK
    {
      "thread_id": "thread-uuid",
      "emails": [{email objects in chronological order}],
      "participants": ["email1@example.com", "email2@example.com"],
      "subject": "Thread subject",
      "total_messages": 7,
      "unread_count": 2
    }

GET /api/v1/emails/{id}/raw
  Description: Get raw RFC 5322 email source
  Headers:
    Authorization: Bearer {access_token}
  Response: 200 OK
    Content-Type: message/rfc822
    {raw email with headers and body}
```

### Email Management

```http
PATCH /api/v1/emails/{id}
  Description: Update email metadata
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "is_read": true,
      "is_starred": false,
      "folder": "Archive",
      "labels": ["work", "important"]
    }
  Response: 200 OK
    {updated email object}
  Sync:
    - Changes synced back to provider (IMAP)
    - Read status updates \Seen flag
    - Starred updates \Flagged

POST /api/v1/emails/{id}/move
  Description: Move email to different folder
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "destination_folder": "Archive"
    }
  Response: 200 OK
    {updated email object}
  Sync: IMAP MOVE command

DELETE /api/v1/emails/{id}
  Description: Move email to trash (soft delete)
  Headers:
    Authorization: Bearer {access_token}
  Response: 204 No Content
  Behavior:
    - Sets deleted_at timestamp
    - Moves to Trash folder
    - Synced with provider
    - Hard deleted after 30 days

POST /api/v1/emails/{id}/restore
  Description: Restore email from trash
  Headers:
    Authorization: Bearer {access_token}
  Response: 200 OK
    {restored email object}
```

### Email Sending

```http
POST /api/v1/emails/send
  Description: Send new email
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "account_email": "user@gmail.com",
      "to": ["recipient@example.com"],
      "cc": [],
      "bcc": [],
      "subject": "Email subject",
      "body_text": "Plain text body",
      "body_html": "<p>HTML body</p>",
      "attachments": ["media-uuid-1", "media-uuid-2"],
      "in_reply_to": "message-id" (optional)
    }
  Response: 201 Created
    {
      "id": "email-uuid",
      "message_id": "<generated-message-id>",
      "status": "sent",
      "sent_at": "2026-02-09T15:00:00Z"
    }
  Processing:
    - Email sent via SMTP
    - Stored in Sent folder
    - Synced with provider
    - Attachments uploaded if needed

POST /api/v1/emails/{id}/reply
  Description: Reply to an email
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "body_text": "Reply text",
      "body_html": "<p>Reply HTML</p>",
      "reply_all": false,
      "attachments": []
    }
  Response: 201 Created
    {new email object}
  Behavior:
    - Sets In-Reply-To header
    - Adds Re: prefix to subject
    - Includes original recipients if reply_all=true
    - Creates parent-child relationship

POST /api/v1/emails/{id}/forward
  Description: Forward an email
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "to": ["forward-to@example.com"],
      "body_text": "Forward message",
      "include_attachments": true
    }
  Response: 201 Created
    {new email object}
  Behavior:
    - Adds Fwd: prefix to subject
    - Includes original message in body
    - Copies attachments if requested
```

### Bulk Operations

```http
POST /api/v1/emails/bulk-update
  Description: Update multiple emails
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "email_ids": ["uuid1", "uuid2", "uuid3"],
      "updates": {
        "is_read": true,
        "labels": ["archived"]
      }
    }
  Response: 200 OK
    {
      "updated_count": 3
    }

POST /api/v1/emails/bulk-move
  Description: Move multiple emails to folder
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "email_ids": ["uuid1", "uuid2"],
      "destination_folder": "Archive"
    }
  Response: 200 OK
    {
      "moved_count": 2
    }

DELETE /api/v1/emails/bulk-delete
  Description: Delete multiple emails
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "email_ids": ["uuid1", "uuid2", "uuid3"]
    }
  Response: 200 OK
    {
      "deleted_count": 3
    }
```

### Sync Operations

```http
POST /api/v1/emails/sync
  Description: Trigger email sync for account
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "account_email": "user@gmail.com",
      "full_sync": false
    }
  Response: 202 Accepted
    {
      "sync_job_id": "job-uuid",
      "status": "queued"
    }

GET /api/v1/emails/sync/status
  Description: Get sync status for account
  Headers:
    Authorization: Bearer {access_token}
  Query Parameters:
    account_email: user@gmail.com
  Response: 200 OK
    {
      "status": "syncing|completed|failed",
      "last_sync_at": "2026-02-09T15:00:00Z",
      "new_emails": 23,
      "updated_emails": 5,
      "errors": []
    }
```

---

## Database Schema (SQLAlchemy Model Reference)

```python
from sqlalchemy import (
    Column, String, Text, Boolean, Integer, BigInteger,
    DateTime, ForeignKey, Index, CheckConstraint, Enum as SQLEnum
)
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import relationship
from app.models.base import BaseObject

class Email(BaseObject):
    """
    Email message object with threading and attachments

    Inherits from BaseObject: id, user_id, created_at, updated_at, deleted_at, metadata
    """

    __tablename__ = "emails"

    # Message Identification (Required)
    message_id = Column(
        String(500),
        nullable=False,
        index=True,
        doc="RFC 5322 Message-ID"
    )
    subject = Column(
        String(1000),
        nullable=False,
        index=True,
        doc="Email subject line"
    )
    sent_at = Column(
        DateTime(timezone=True),
        nullable=False,
        index=True,
        doc="When email was sent"
    )

    # Message Content (Required)
    body_text = Column(
        Text,
        nullable=True,
        doc="Plain text email body"
    )
    body_html = Column(
        Text,
        nullable=True,
        doc="HTML email body"
    )
    has_attachments = Column(
        Boolean,
        nullable=False,
        default=False,
        index=True,
        doc="Whether email has attachments"
    )

    # Sender and Recipients (Required)
    from_address = Column(
        String(500),
        nullable=False,
        index=True,
        doc="Sender email address"
    )
    from_name = Column(
        String(500),
        nullable=True,
        doc="Sender display name"
    )
    to_addresses = Column(
        JSONB,
        nullable=False,
        default=[],
        doc="Array of To: recipients"
    )
    cc_addresses = Column(
        JSONB,
        nullable=False,
        default=[],
        doc="Array of CC recipients"
    )
    bcc_addresses = Column(
        JSONB,
        nullable=False,
        default=[],
        doc="Array of BCC recipients"
    )

    # Threading (Optional)
    thread_id = Column(
        String(500),
        nullable=True,
        index=True,
        doc="Conversation thread ID"
    )
    in_reply_to = Column(
        String(500),
        nullable=True,
        index=True,
        doc="Message-ID of email being replied to"
    )
    references = Column(
        JSONB,
        nullable=True,
        doc="Array of referenced Message-IDs"
    )
    parent_email_id = Column(
        UUID(as_uuid=True),
        ForeignKey('emails.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        doc="Parent email in thread"
    )

    # Classification (Optional)
    folder = Column(
        String(200),
        nullable=True,
        index=True,
        doc="Mailbox folder"
    )
    labels = Column(
        JSONB,
        nullable=False,
        default=[],
        doc="Array of labels/tags"
    )
    is_read = Column(
        Boolean,
        nullable=False,
        default=False,
        index=True,
        doc="Read status"
    )
    is_starred = Column(
        Boolean,
        nullable=False,
        default=False,
        index=True,
        doc="Starred/flagged status"
    )
    is_important = Column(
        Boolean,
        nullable=False,
        default=False,
        index=True,
        doc="Important status"
    )
    priority = Column(
        SQLEnum('high', 'normal', 'low', name='email_priority_enum'),
        nullable=True,
        index=True,
        doc="Email priority"
    )

    # Attachments (Optional)
    attachment_count = Column(
        Integer,
        nullable=False,
        default=0,
        doc="Number of attachments"
    )
    total_attachment_size = Column(
        BigInteger,
        nullable=False,
        default=0,
        doc="Total attachment size in bytes"
    )

    # Source and Sync (Optional)
    account_email = Column(
        String(500),
        nullable=True,
        index=True,
        doc="Email account this belongs to"
    )
    provider = Column(
        String(100),
        nullable=True,
        index=True,
        doc="Email provider"
    )
    integration_id = Column(
        UUID(as_uuid=True),
        ForeignKey('integrations.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        doc="Integration that synced this email"
    )
    imap_uid = Column(
        BigInteger,
        nullable=True,
        index=True,
        doc="IMAP UID on server"
    )
    smtp_message_id = Column(
        String(500),
        nullable=True,
        doc="SMTP envelope Message-ID"
    )

    # Delivery (Optional)
    received_at = Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        doc="When received by server"
    )
    delivered_at = Column(
        DateTime(timezone=True),
        nullable=True,
        doc="When delivered to recipient"
    )
    read_at = Column(
        DateTime(timezone=True),
        nullable=True,
        doc="When first marked as read"
    )
    bounce_status = Column(
        String(50),
        nullable=True,
        doc="Delivery/bounce status"
    )

    # Relationships
    owner = relationship("User", foreign_keys=[BaseObject.user_id])
    integration = relationship("Integration", foreign_keys=[integration_id])
    parent_email = relationship(
        "Email",
        remote_side="Email.id",
        foreign_keys=[parent_email_id]
    )
    attachments = relationship(
        "Media",
        secondary="email_attachments",
        back_populates="emails"
    )

    # Table Constraints
    __table_args__ = (
        # Message ID must be unique per user
        Index('idx_email_user_message_id', 'user_id', 'message_id', unique=True),

        # Attachment counts must be non-negative
        CheckConstraint(
            'attachment_count >= 0',
            name='check_attachment_count_positive'
        ),
        CheckConstraint(
            'total_attachment_size >= 0',
            name='check_attachment_size_positive'
        ),

        # Composite indexes for common queries
        Index('idx_email_account_folder', 'account_email', 'folder'),
        Index('idx_email_thread', 'thread_id'),
        Index('idx_email_sent_at', 'sent_at'),
        Index('idx_email_from', 'from_address'),

        # GIN indexes for array fields
        Index('idx_email_to_addresses', 'to_addresses', postgresql_using='gin'),
        Index('idx_email_labels', 'labels', postgresql_using='gin'),

        # Filtered indexes for performance
        Index('idx_email_unread', 'user_id', 'is_read', postgresql_where='is_read = false'),
        Index('idx_email_starred', 'user_id', 'is_starred', postgresql_where='is_starred = true'),
    )

    def __repr__(self):
        return f"<Email(id={self.id}, subject='{self.subject[:50]}...', from={self.from_address})>"

    @property
    def is_reply(self):
        return self.in_reply_to is not None or self.parent_email_id is not None

    @property
    def all_recipients(self):
        """Get all recipients (To + CC + BCC)"""
        return list(set(self.to_addresses + self.cc_addresses + self.bcc_addresses))
```

---

## Privacy and Security Considerations

### Access Control

1. **Ownership Enforcement**
   - Emails only accessible by owner
   - Multi-account support with proper isolation
   - No cross-user email access

2. **Encryption**
   - Email bodies encrypted at rest
   - TLS for all IMAP/SMTP connections
   - Support for PGP/S/MIME encrypted emails

3. **Authentication**
   - OAuth 2.0 for Gmail, Outlook, etc.
   - App-specific passwords for IMAP/SMTP
   - No storage of primary account passwords

### Data Protection

1. **GDPR Compliance**
   - User can export all emails and metadata
   - User can delete all emails permanently
   - Right to be forgotten (delete all data)

2. **Privacy Features**
   - Option to disable tracking pixels
   - Warning for tracking links
   - Automatic phishing detection
   - Spam filtering

---

## Validation Rules

### On Creation/Import

```yaml
message_id:
  - Must be unique per user
  - Must be valid RFC 5322 format
  - Required for import (generated for sent emails)

email_addresses:
  - All addresses must be valid email format
  - At least one To: recipient for sent emails
  - From address required

content:
  - At least one of body_text or body_html required
  - HTML sanitized for security
  - Subject can be empty
```

---

## Use Cases and Examples

### Example 1: Gmail Import

```json
{
  "id": "email-uuid-001",
  "user_id": "user-uuid",
  "message_id": "<CAGFj3YmZ9x@mail.gmail.com>",
  "subject": "Re: Q4 Budget Review Meeting",
  "sent_at": "2024-02-09T14:30:00Z",
  "from_address": "john.doe@company.com",
  "from_name": "John Doe",
  "to_addresses": ["team@company.com"],
  "cc_addresses": ["manager@company.com"],
  "bcc_addresses": [],
  "body_text": "Thanks for scheduling this. I'll prepare the slides.",
  "body_html": "<p>Thanks for scheduling this. I'll prepare the slides.</p>",
  "has_attachments": true,
  "attachment_count": 2,
  "thread_id": "16f8a1b2c3d4e5f6",
  "in_reply_to": "<previous-message-id@mail.gmail.com>",
  "folder": "INBOX",
  "labels": ["work", "important"],
  "is_read": true,
  "is_starred": false,
  "account_email": "user@gmail.com",
  "provider": "gmail",
  "created_at": "2026-02-09T15:00:00Z"
}
```

---

**Status:** Active - Core Communication Type
**Version:** 1.0
**Authority:** 0.0.4 - Communication Types
**Created:** 2026-02-09
**Owner:** Hypernet Core (0.*)
