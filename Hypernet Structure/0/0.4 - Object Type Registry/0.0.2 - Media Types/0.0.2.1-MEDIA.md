---
ha: "0.4.0.2.1"
object_type: "document"
creator: "1.1"
created: "2026-02-09"
status: "active"
visibility: "public"
flags: ["registry"]
---

# MEDIA - Photos, Videos, Audio, and Documents Object Type

**Type ID:** `hypernet.media.media`
**Version:** 1.0
**Category:** 0.0.2 - Media Types
**Parent:** BaseObject
**Status:** Active - Core Media Type
**Created:** 2026-02-09
**Last Updated:** 2026-02-09

---

## Object Type Metadata

```yaml
type_name: "Media"
type_id: "hypernet.media.media"
version: "1.0"
parent_type: "BaseObject"
category: "0.0.2 - Media Types"
abstract: false
instantiable: true
```

---

## Purpose and Description

### What is Media?

The Media object type represents any digital file imported into or created within Hypernet. This includes photos, videos, audio recordings, documents, and other file types. Media is the foundational content object in Hypernet's unified data model, enabling users to aggregate, organize, and manage their digital content from any source.

### Revolutionary Design Philosophy

Hypernet treats all media as first-class objects with rich metadata, relationships, and lifecycle management:
- **Source Agnostic** - Media from Instagram, Google Photos, local files, or AI-generated content all use the same object type
- **Metadata Rich** - Automatic extraction and preservation of EXIF, file properties, and platform-specific metadata
- **Relationship Aware** - Media can belong to albums, appear in posts, be tagged with people and locations
- **AI Enhanced** - Automatic tagging, face detection, object recognition, and content analysis
- **Privacy First** - Fine-grained privacy controls and encryption for sensitive content

### Core Functions

1. **Content Storage** - Store original files with optional compression and format conversion
2. **Metadata Management** - Extract, preserve, and enrich metadata from all sources
3. **Organization** - Group media into albums, tag with subjects, organize by time and location
4. **Search and Discovery** - Full-text search, visual similarity, smart filters
5. **Sharing and Collaboration** - Control who can view, download, or edit media
6. **Lifecycle Management** - Track creation, modification, deletion, and archival

### When to Use

- Importing photos from social media platforms (Instagram, Facebook, etc.)
- Uploading files from local devices or cloud storage
- Storing AI-generated content (images, audio, documents)
- Managing documents, receipts, screenshots, and other file types
- Creating collections and galleries
- Any scenario requiring file storage with rich metadata

---

## Inherited Fields from BaseObject

```yaml
id: UUID
  - Globally unique media identifier
  - Generated on creation or import

created_at: DateTime
  - Import timestamp (when added to Hypernet)
  - Immutable
  - May differ from taken_at (original creation time)

updated_at: DateTime
  - Last modification timestamp
  - Auto-updated on any field change or metadata update

deleted_at: DateTime (nullable)
  - Soft delete timestamp
  - Null for active media
  - Media preserved in trash for 30 days before hard delete

user_id: UUID
  - Foreign key to User who owns this media
  - Required - all media must have an owner
  - Immutable (use ownership transfer API for changes)

metadata: JSONB
  - Extensible metadata storage
  - See Metadata Schema section below
  - Stores platform-specific data, EXIF, AI analysis
```

---

## Required Fields

### File Information

```yaml
file_path: String(1000)
  type: String
  max_length: 1000
  nullable: false
  indexed: true
  description: "Relative path to file in object storage (S3, local, etc.)"
  format: "users/{user_id}/media/{year}/{month}/{id}.{ext}"
  examples:
    - "users/uuid/media/2024/02/photo-uuid.jpg"
    - "users/uuid/media/2024/02/video-uuid.mp4"
    - "users/uuid/media/2024/02/doc-uuid.pdf"
  constraints:
    - Path must be unique per user
    - File must exist in object storage
    - Supports hierarchical organization

file_size: BigInteger
  type: BigInteger
  nullable: false
  indexed: true
  description: "File size in bytes"
  unit: "bytes"
  constraints:
    - Must be > 0
    - Must not exceed user's storage quota
    - Counted toward user's storage_used
  validation:
    - Verified on upload
    - Re-validated on storage reconciliation

mime_type: String(100)
  type: String
  max_length: 100
  nullable: false
  indexed: true
  description: "MIME type of the file"
  examples:
    - "image/jpeg"
    - "image/png"
    - "video/mp4"
    - "audio/mpeg"
    - "application/pdf"
    - "image/heic"
  constraints:
    - Must be valid MIME type
    - Determines media_type classification
    - Used for rendering and processing
```

### Media Classification

```yaml
media_type: Enum
  type: String
  max_length: 20
  nullable: false
  indexed: true
  description: "High-level classification of media"
  allowed_values:
    - "photo": Still images (JPEG, PNG, GIF, HEIC, etc.)
    - "video": Video files (MP4, MOV, AVI, etc.)
    - "audio": Audio files (MP3, WAV, AAC, etc.)
    - "document": Documents and text (PDF, DOCX, TXT, etc.)
    - "other": Unrecognized or misc file types
  derivation: "Automatically determined from mime_type"
  examples:
    - image/* -> "photo"
    - video/* -> "video"
    - audio/* -> "audio"
    - application/pdf, text/* -> "document"

file_name: String(500)
  type: String
  max_length: 500
  nullable: false
  indexed: false
  description: "Original filename from source"
  examples:
    - "IMG_1234.jpg"
    - "vacation_video.mp4"
    - "meeting_notes.pdf"
    - "441234567890_abc.jpg" (Instagram export format)
  constraints:
    - Preserved from original source
    - May include extension
    - Not required to be unique
    - Used for display and download
```

---

## Optional Fields

### Temporal Information

```yaml
taken_at: DateTime
  type: DateTime
  nullable: true
  indexed: true
  timezone: true
  description: "When the media was originally created/captured"
  sources:
    - EXIF DateTimeOriginal for photos
    - Video file creation time
    - Document creation date
    - Platform timestamp from API
  fallback: "created_at if not available"
  usage: "Primary field for timeline organization"

captured_at: DateTime
  type: DateTime
  nullable: true
  indexed: true
  timezone: true
  description: "Specific capture timestamp (may differ from taken_at)"
  purpose: "Some platforms distinguish creation from capture time"

modified_at: DateTime
  type: DateTime
  nullable: true
  timezone: true
  description: "Last modification time from original source"
  examples:
    - EXIF DateTime (if different from DateTimeOriginal)
    - File system modified time
```

### Geolocation

```yaml
latitude: Decimal(10,8)
  type: Decimal
  precision: 10
  scale: 8
  nullable: true
  indexed: true
  description: "GPS latitude coordinate"
  range: "-90.0 to 90.0"
  sources:
    - EXIF GPS coordinates
    - Video metadata
    - Platform location data
  privacy: "Stripped from public exports if user preference set"

longitude: Decimal(11,8)
  type: Decimal
  precision: 11
  scale: 8
  nullable: true
  indexed: true
  description: "GPS longitude coordinate"
  range: "-180.0 to 180.0"
  sources: "Same as latitude"

altitude: Decimal(8,2)
  type: Decimal
  precision: 8
  scale: 2
  nullable: true
  description: "GPS altitude in meters"
  unit: "meters"
  sources: "EXIF GPS altitude"

location_name: String(500)
  type: String
  max_length: 500
  nullable: true
  indexed: true
  description: "Human-readable location name"
  examples:
    - "Golden Gate Bridge, San Francisco, CA"
    - "Home"
    - "Tokyo, Japan"
  sources:
    - Reverse geocoded from lat/lng
    - Platform location tag
    - User-provided
  searchable: true
```

### Dimensions (Photo/Video)

```yaml
width: Integer
  type: Integer
  nullable: true
  description: "Media width in pixels"
  constraints:
    - Must be > 0 if provided
    - Applicable to photos and videos
  usage: "Display and thumbnail generation"

height: Integer
  type: Integer
  nullable: true
  description: "Media height in pixels"
  constraints:
    - Must be > 0 if provided
    - Applicable to photos and videos
  usage: "Display and thumbnail generation"

duration: Integer
  type: Integer
  nullable: true
  description: "Duration in seconds (video/audio)"
  unit: "seconds"
  constraints:
    - Must be > 0 if provided
    - Only applicable to video and audio
  examples:
    - Video: 120 (2 minutes)
    - Audio: 180 (3 minutes)
```

### Content Description

```yaml
title: String(500)
  type: String
  max_length: 500
  nullable: true
  indexed: true
  description: "User-provided or platform title"
  examples:
    - "Sunset at the beach"
    - "Birthday party 2024"
    - "Q4 Financial Report"
  searchable: true
  sources:
    - User input
    - Platform caption
    - Document title metadata

caption: Text
  type: Text
  nullable: true
  max_length: 10000
  description: "Detailed description or caption"
  searchable: true
  sources:
    - Instagram/Facebook caption
    - User-added description
    - AI-generated description
  format: "Plain text or Markdown"

alt_text: String(1000)
  type: String
  max_length: 1000
  nullable: true
  description: "Accessibility description"
  purpose: "Screen reader support, SEO"
  sources:
    - Platform alt text
    - AI-generated description
    - User-provided

tags: JSONB
  type: JSONB
  nullable: false
  default: []
  description: "Array of tag strings for categorization"
  structure: ["tag1", "tag2", "tag3"]
  examples:
    - ["family", "vacation", "beach"]
    - ["work", "presentation", "2024"]
  searchable: true
  indexed: "GIN index for containment queries"
```

### Processing Status

```yaml
processing_status: Enum
  type: String
  max_length: 20
  nullable: false
  default: "pending"
  indexed: true
  description: "Processing pipeline status"
  allowed_values:
    - "pending": Uploaded but not processed
    - "processing": Currently being processed
    - "completed": Successfully processed
    - "failed": Processing failed
    - "skipped": Processing not needed
  workflow:
    pending -> processing -> completed
    pending -> processing -> failed
    pending -> skipped

thumbnail_path: String(1000)
  type: String
  max_length: 1000
  nullable: true
  description: "Path to generated thumbnail image"
  format: "users/{user_id}/media/{year}/{month}/thumbnails/{id}_thumb.jpg"
  generation:
    - Auto-generated for photos
    - First frame for videos
    - Icon for documents
  sizes: "Multiple sizes: 150x150, 300x300, 600x600"

hash_sha256: String(64)
  type: String
  max_length: 64
  nullable: true
  indexed: true
  description: "SHA-256 hash of file content"
  format: "64 character hex string"
  purpose: "Deduplication, integrity verification"
  computed: "On upload or async processing"

hash_perceptual: String(64)
  type: String
  max_length: 64
  nullable: true
  indexed: true
  description: "Perceptual hash (pHash) for visual similarity"
  applicable: "Photos and videos only"
  purpose: "Find visually similar images, detect duplicates"
  computed: "Via AI processing pipeline"
```

### Source Information

```yaml
source_platform: String(100)
  type: String
  max_length: 100
  nullable: true
  indexed: true
  description: "Platform/service where media originated"
  examples:
    - "instagram"
    - "facebook"
    - "google_photos"
    - "dropbox"
    - "local_upload"
    - "ai_generated"
  usage: "Track data provenance, display source badges"

source_id: String(200)
  type: String
  max_length: 200
  nullable: true
  indexed: true
  description: "External ID from source platform"
  examples:
    - Instagram media ID: "2847593720193"
    - Google Photos ID: "AF1QipN..."
  purpose: "Prevent duplicate imports, sync updates"

source_url: String(1000)
  type: String
  max_length: 1000
  nullable: true
  description: "Original URL from platform (if applicable)"
  examples:
    - "https://www.instagram.com/p/ABC123/"
    - "https://photos.google.com/photo/xyz"
  usage: "Link back to original, attribution"

integration_id: UUID
  type: UUID
  nullable: true
  indexed: true
  description: "Foreign key to Integration that imported this media"
  references: "Integration.id"
  cascade: "ON DELETE SET NULL"
  purpose: "Track which integration imported the media"
```

---

## Metadata Schema

The `metadata` JSONB field stores extensible platform-specific and analysis data:

```json
{
  "exif": {
    "make": "Apple",
    "model": "iPhone 15 Pro",
    "lens": "iPhone 15 Pro back triple camera 6.86mm f/1.78",
    "iso": 200,
    "aperture": "f/1.78",
    "shutter_speed": "1/120",
    "focal_length": "6.86mm",
    "white_balance": "Auto",
    "flash": "No flash",
    "orientation": 1
  },
  "platform": {
    "instagram": {
      "post_id": "ABC123",
      "permalink": "https://instagram.com/p/ABC123",
      "like_count": 324,
      "comment_count": 18,
      "filter": "Clarendon",
      "is_video": false
    },
    "google_photos": {
      "album_id": "xyz789",
      "shared": false,
      "archived": false
    }
  },
  "ai_analysis": {
    "labels": [
      {"label": "sunset", "confidence": 0.98},
      {"label": "beach", "confidence": 0.95},
      {"label": "ocean", "confidence": 0.93}
    ],
    "faces": [
      {
        "face_id": "face-uuid",
        "person_id": "person-uuid",
        "confidence": 0.97,
        "bounding_box": {"x": 120, "y": 340, "width": 180, "height": 220}
      }
    ],
    "text": "Extracted text from image via OCR",
    "dominant_colors": ["#FF6B4A", "#4A90E2", "#F5A623"],
    "quality_score": 0.89,
    "inappropriate_content": false,
    "content_categories": ["nature", "landscape"]
  },
  "processing": {
    "thumbnail_generated": true,
    "hash_computed": true,
    "ai_analyzed": true,
    "transcoded": false,
    "processing_time_ms": 1234
  },
  "file_info": {
    "original_name": "IMG_1234.jpg",
    "extension": "jpg",
    "encoding": "UTF-8",
    "compression": "JPEG"
  }
}
```

---

## Relationships to Other Object Types

### Ownership

```yaml
owned_by: User
  description: "User who owns this media"
  cardinality: "N:1 (many media, one owner)"
  implementation: "user_id foreign key"
  cascade: "ON DELETE CASCADE (delete media if user deleted)"

imported_by: Integration
  description: "Integration that imported this media"
  cardinality: "N:1 (many media, one integration)"
  implementation: "integration_id foreign key"
  cascade: "ON DELETE SET NULL"
```

### Organization

```yaml
in_albums: Album
  description: "Albums containing this media"
  cardinality: "M:N (many media, many albums)"
  link_type: "album_media"
  implementation: "Join table with ordering"
  examples:
    - Photo appears in "Vacation 2024" and "Best Photos" albums

appears_in: SocialPost
  description: "Social posts featuring this media"
  cardinality: "M:N (many media, many posts)"
  link_type: "post_media"
  implementation: "Join table with ordering"
  examples:
    - Photo used in Instagram post and Facebook post
```

### People and Places

```yaml
depicts: Person
  description: "People appearing in this media"
  cardinality: "M:N (many media, many people)"
  link_type: "media_person"
  implementation: "Join table with face metadata"
  sources:
    - Face recognition
    - Manual tagging

taken_at_location: Location
  description: "Named location where media was captured"
  cardinality: "N:1 (many media, one location)"
  link_type: "taken_at"
  implementation: "Location object with reverse geocoding"
```

### Derivatives

```yaml
has_thumbnails: Media
  description: "Thumbnail versions of this media"
  cardinality: "1:N (one original, many thumbnails)"
  link_type: "thumbnail_of"
  implementation: "parent_media_id foreign key"

transcoded_versions: Media
  description: "Format-converted versions (e.g., HEIC to JPEG)"
  cardinality: "1:N (one original, many versions)"
  link_type: "version_of"
```

---

## API Endpoints

### Media Upload

```http
POST /api/v1/media
  Description: Upload new media file
  Headers:
    Authorization: Bearer {access_token}
    Content-Type: multipart/form-data
  Request Body:
    file: [binary file data]
    title: "Optional title"
    caption: "Optional caption"
    tags: ["tag1", "tag2"]
    taken_at: "2024-02-09T14:30:00Z"
  Response: 201 Created
    {
      "id": "media-uuid",
      "file_name": "IMG_1234.jpg",
      "file_size": 2456789,
      "mime_type": "image/jpeg",
      "media_type": "photo",
      "processing_status": "pending",
      "created_at": "2026-02-09T15:00:00Z"
    }
  Processing:
    - File stored in object storage
    - Hash computed
    - Thumbnail generation queued
    - AI analysis queued
    - Returns immediately with pending status
  Limits:
    - Max file size: 5 GB per file
    - Rate limit: 100 uploads per hour per user
```

### Media Retrieval

```http
GET /api/v1/media/{id}
  Description: Get media metadata
  Headers:
    Authorization: Bearer {access_token}
  Response: 200 OK
    {complete media object}
  Privacy:
    - Only owner can access
    - Returns 404 if not found or unauthorized

GET /api/v1/media/{id}/file
  Description: Download original media file
  Headers:
    Authorization: Bearer {access_token}
  Response: 200 OK
    Content-Type: {mime_type}
    Content-Disposition: attachment; filename="{file_name}"
    [binary file data]
  Options:
    ?size=thumbnail - Return thumbnail instead of original
    ?format=jpg - Convert format on-the-fly (if supported)

GET /api/v1/media/{id}/thumbnail
  Description: Get thumbnail image
  Headers:
    Authorization: Bearer {access_token}
  Query Parameters:
    size: 150|300|600 (default: 300)
  Response: 200 OK
    Content-Type: image/jpeg
    [thumbnail image data]
  Caching:
    - Cache-Control: public, max-age=86400
    - ETag support for efficient caching
```

### Media Management

```http
PATCH /api/v1/media/{id}
  Description: Update media metadata
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "title": "Updated title",
      "caption": "Updated caption",
      "tags": ["new", "tags"],
      "latitude": 37.7749,
      "longitude": -122.4194,
      "location_name": "San Francisco, CA"
    }
  Response: 200 OK
    {updated media object}
  Constraints:
    - Cannot modify: file_path, file_size, hash fields
    - Can modify: title, caption, tags, location, dates

DELETE /api/v1/media/{id}
  Description: Soft delete media
  Headers:
    Authorization: Bearer {access_token}
  Response: 204 No Content
  Behavior:
    - Sets deleted_at timestamp
    - File preserved for 30 days
    - User storage_used updated
    - Media removed from albums and posts
```

### Bulk Operations

```http
GET /api/v1/media
  Description: List user's media with filtering
  Headers:
    Authorization: Bearer {access_token}
  Query Parameters:
    media_type: photo|video|audio|document
    album_id: {album-uuid} - Media in specific album
    tag: {tag-name} - Media with specific tag
    location: {location-name} - Media at location
    date_from: 2024-01-01
    date_to: 2024-12-31
    limit: 50 (default: 50, max: 200)
    offset: 0
    sort: taken_at|created_at|file_size (default: taken_at)
    order: asc|desc (default: desc)
  Response: 200 OK
    {
      "media": [{media objects}],
      "total": 1543,
      "limit": 50,
      "offset": 0
    }

POST /api/v1/media/bulk-update
  Description: Update multiple media at once
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "media_ids": ["uuid1", "uuid2", "uuid3"],
      "updates": {
        "tags": ["vacation", "2024"],
        "location_name": "Hawaii"
      }
    }
  Response: 200 OK
    {
      "updated_count": 3,
      "media": [{updated media objects}]
    }

DELETE /api/v1/media/bulk-delete
  Description: Delete multiple media at once
  Headers:
    Authorization: Bearer {access_token}
  Request Body:
    {
      "media_ids": ["uuid1", "uuid2", "uuid3"]
    }
  Response: 200 OK
    {
      "deleted_count": 3
    }
```

---

## Database Schema (SQLAlchemy Model Reference)

```python
from sqlalchemy import (
    Column, String, BigInteger, Integer, Enum as SQLEnum,
    DateTime, Numeric, ForeignKey, Index, CheckConstraint, Text
)
from sqlalchemy.dialects.postgresql import UUID, JSONB, ARRAY
from sqlalchemy.orm import relationship
from app.models.base import BaseObject

class Media(BaseObject):
    """
    Media object - photos, videos, audio, documents

    Inherits from BaseObject: id, user_id, created_at, updated_at, deleted_at, metadata
    """

    __tablename__ = "media"

    # File Information (Required)
    file_path = Column(
        String(1000),
        nullable=False,
        index=True,
        doc="Relative path to file in object storage"
    )
    file_size = Column(
        BigInteger,
        nullable=False,
        index=True,
        doc="File size in bytes"
    )
    mime_type = Column(
        String(100),
        nullable=False,
        index=True,
        doc="MIME type of the file"
    )

    # Media Classification (Required)
    media_type = Column(
        SQLEnum('photo', 'video', 'audio', 'document', 'other',
                name='media_type_enum'),
        nullable=False,
        index=True,
        doc="High-level media classification"
    )
    file_name = Column(
        String(500),
        nullable=False,
        doc="Original filename from source"
    )

    # Temporal Information (Optional)
    taken_at = Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        doc="When media was originally created/captured"
    )
    captured_at = Column(
        DateTime(timezone=True),
        nullable=True,
        index=True,
        doc="Specific capture timestamp"
    )
    modified_at = Column(
        DateTime(timezone=True),
        nullable=True,
        doc="Last modification time from source"
    )

    # Geolocation (Optional)
    latitude = Column(
        Numeric(10, 8),
        nullable=True,
        index=True,
        doc="GPS latitude coordinate"
    )
    longitude = Column(
        Numeric(11, 8),
        nullable=True,
        index=True,
        doc="GPS longitude coordinate"
    )
    altitude = Column(
        Numeric(8, 2),
        nullable=True,
        doc="GPS altitude in meters"
    )
    location_name = Column(
        String(500),
        nullable=True,
        index=True,
        doc="Human-readable location name"
    )

    # Dimensions (Optional)
    width = Column(
        Integer,
        nullable=True,
        doc="Media width in pixels"
    )
    height = Column(
        Integer,
        nullable=True,
        doc="Media height in pixels"
    )
    duration = Column(
        Integer,
        nullable=True,
        doc="Duration in seconds (video/audio)"
    )

    # Content Description (Optional)
    title = Column(
        String(500),
        nullable=True,
        index=True,
        doc="User-provided or platform title"
    )
    caption = Column(
        Text,
        nullable=True,
        doc="Detailed description or caption"
    )
    alt_text = Column(
        String(1000),
        nullable=True,
        doc="Accessibility description"
    )
    tags = Column(
        JSONB,
        nullable=False,
        default=[],
        doc="Array of tag strings"
    )

    # Processing Status (Optional)
    processing_status = Column(
        SQLEnum('pending', 'processing', 'completed', 'failed', 'skipped',
                name='processing_status_enum'),
        nullable=False,
        default='pending',
        index=True,
        doc="Processing pipeline status"
    )
    thumbnail_path = Column(
        String(1000),
        nullable=True,
        doc="Path to generated thumbnail"
    )
    hash_sha256 = Column(
        String(64),
        nullable=True,
        index=True,
        doc="SHA-256 hash of file content"
    )
    hash_perceptual = Column(
        String(64),
        nullable=True,
        index=True,
        doc="Perceptual hash for visual similarity"
    )

    # Source Information (Optional)
    source_platform = Column(
        String(100),
        nullable=True,
        index=True,
        doc="Platform where media originated"
    )
    source_id = Column(
        String(200),
        nullable=True,
        index=True,
        doc="External ID from source platform"
    )
    source_url = Column(
        String(1000),
        nullable=True,
        doc="Original URL from platform"
    )
    integration_id = Column(
        UUID(as_uuid=True),
        ForeignKey('integrations.id', ondelete='SET NULL'),
        nullable=True,
        index=True,
        doc="Integration that imported this media"
    )

    # Relationships
    owner = relationship("User", foreign_keys=[BaseObject.user_id])
    integration = relationship("Integration", foreign_keys=[integration_id])
    albums = relationship(
        "Album",
        secondary="album_media",
        back_populates="media"
    )

    # Table Constraints
    __table_args__ = (
        # File size must be positive
        CheckConstraint('file_size > 0', name='check_file_size_positive'),

        # Dimensions must be positive if provided
        CheckConstraint(
            'width IS NULL OR width > 0',
            name='check_width_positive'
        ),
        CheckConstraint(
            'height IS NULL OR height > 0',
            name='check_height_positive'
        ),
        CheckConstraint(
            'duration IS NULL OR duration > 0',
            name='check_duration_positive'
        ),

        # Latitude range
        CheckConstraint(
            'latitude IS NULL OR (latitude >= -90 AND latitude <= 90)',
            name='check_latitude_range'
        ),

        # Longitude range
        CheckConstraint(
            'longitude IS NULL OR (longitude >= -180 AND longitude <= 180)',
            name='check_longitude_range'
        ),

        # Composite indexes
        Index('idx_media_user_type', 'user_id', 'media_type'),
        Index('idx_media_taken_at', 'taken_at'),
        Index('idx_media_location', 'latitude', 'longitude'),
        Index('idx_media_source', 'source_platform', 'source_id'),
        Index('idx_media_hash', 'hash_sha256'),

        # GIN index for tags array
        Index('idx_media_tags', 'tags', postgresql_using='gin'),
    )

    def __repr__(self):
        return f"<Media(id={self.id}, type={self.media_type}, file={self.file_name})>"

    @property
    def is_image(self):
        return self.media_type == 'photo'

    @property
    def is_video(self):
        return self.media_type == 'video'

    @property
    def is_audio(self):
        return self.media_type == 'audio'

    @property
    def has_location(self):
        return self.latitude is not None and self.longitude is not None
```

---

## Privacy and Security Considerations

### Access Control

1. **Ownership Enforcement**
   - Media only accessible by owner
   - No public sharing without explicit permission
   - Album sharing controls cascaded to media

2. **Location Privacy**
   - GPS coordinates stripped from public exports by default
   - User preference: "Strip location from shared media"
   - Coarse location only (city-level) in shared contexts

3. **Content Security**
   - Files stored in private object storage (S3, etc.)
   - Pre-signed URLs with expiration for downloads
   - Thumbnail access requires authentication

### Data Protection

1. **Encryption**
   - Files encrypted at rest (S3 server-side encryption)
   - Sensitive metadata encrypted in database
   - TLS for all file transfers

2. **Deduplication**
   - Hash-based deduplication at user level
   - Original files preserved even if duplicates exist
   - Storage savings passed to user

3. **GDPR Compliance**
   - User can export all media and metadata
   - User can delete all media (soft delete with 30-day grace)
   - Face recognition data deleted on user request

---

## Validation Rules

### On Upload

```yaml
file:
  - Must be valid file format
  - Size must be > 0 and <= 5 GB
  - MIME type must match file content
  - Virus scan passed

user_quota:
  - storage_used + file_size <= storage_quota
  - Reject upload if quota exceeded

metadata:
  - title max 500 chars
  - caption max 10,000 chars
  - tags: each tag max 100 chars, max 50 tags
```

### On Update

```yaml
immutable_fields:
  - id, user_id
  - file_path, file_size, mime_type
  - hash_sha256, hash_perceptual
  - created_at

mutable_fields:
  - title, caption, alt_text, tags
  - location fields (lat, lng, location_name)
  - taken_at, captured_at
  - width, height, duration (if incorrect initially)
```

---

## Use Cases and Examples

### Example 1: Instagram Photo Import

```json
{
  "id": "media-550e8400-e29b-41d4-a716-446655440000",
  "user_id": "user-uuid",
  "file_path": "users/user-uuid/media/2024/02/photo-uuid.jpg",
  "file_size": 2456789,
  "mime_type": "image/jpeg",
  "media_type": "photo",
  "file_name": "441234567890_abc.jpg",
  "taken_at": "2024-02-09T14:30:00Z",
  "latitude": 37.7749,
  "longitude": -122.4194,
  "location_name": "San Francisco, CA",
  "width": 1080,
  "height": 1080,
  "title": "Golden Gate at sunset",
  "caption": "Beautiful evening walk across the bridge #sunset #goldengatebridge",
  "tags": ["sunset", "travel", "sanfrancisco"],
  "processing_status": "completed",
  "thumbnail_path": "users/user-uuid/media/2024/02/thumbnails/photo-uuid_thumb.jpg",
  "hash_sha256": "abc123...",
  "hash_perceptual": "def456...",
  "source_platform": "instagram",
  "source_id": "2847593720193",
  "source_url": "https://www.instagram.com/p/ABC123/",
  "integration_id": "integration-uuid",
  "metadata": {
    "exif": {
      "make": "Apple",
      "model": "iPhone 15 Pro",
      "iso": 200
    },
    "platform": {
      "instagram": {
        "like_count": 324,
        "comment_count": 18,
        "filter": "Clarendon"
      }
    },
    "ai_analysis": {
      "labels": [
        {"label": "bridge", "confidence": 0.98},
        {"label": "sunset", "confidence": 0.95}
      ]
    }
  },
  "created_at": "2026-02-09T15:00:00Z",
  "updated_at": "2026-02-09T15:05:00Z",
  "deleted_at": null
}
```

### Example 2: Local Video Upload

```json
{
  "id": "media-660e8400-e29b-41d4-a716-446655440001",
  "user_id": "user-uuid",
  "file_path": "users/user-uuid/media/2024/02/video-uuid.mp4",
  "file_size": 125829120,
  "mime_type": "video/mp4",
  "media_type": "video",
  "file_name": "birthday_party.mp4",
  "taken_at": "2024-02-08T18:00:00Z",
  "width": 1920,
  "height": 1080,
  "duration": 180,
  "title": "Sarah's Birthday Party",
  "caption": "Amazing celebration with friends and family!",
  "tags": ["birthday", "family", "celebration"],
  "processing_status": "completed",
  "thumbnail_path": "users/user-uuid/media/2024/02/thumbnails/video-uuid_thumb.jpg",
  "hash_sha256": "xyz789...",
  "source_platform": "local_upload",
  "created_at": "2026-02-09T16:00:00Z",
  "updated_at": "2026-02-09T16:10:00Z",
  "deleted_at": null
}
```

### Example 3: PDF Document

```json
{
  "id": "media-770e8400-e29b-41d4-a716-446655440002",
  "user_id": "user-uuid",
  "file_path": "users/user-uuid/media/2024/02/doc-uuid.pdf",
  "file_size": 5242880,
  "mime_type": "application/pdf",
  "media_type": "document",
  "file_name": "Q4_2024_Report.pdf",
  "taken_at": "2024-01-15T09:00:00Z",
  "title": "Q4 2024 Financial Report",
  "tags": ["work", "finance", "2024", "report"],
  "processing_status": "completed",
  "thumbnail_path": "users/user-uuid/media/2024/02/thumbnails/doc-uuid_thumb.jpg",
  "hash_sha256": "report123...",
  "source_platform": "local_upload",
  "metadata": {
    "file_info": {
      "pages": 24,
      "author": "Finance Team",
      "creation_date": "2024-01-15T09:00:00Z"
    },
    "ai_analysis": {
      "text": "Extracted text content via OCR...",
      "categories": ["finance", "business"]
    }
  },
  "created_at": "2026-02-09T17:00:00Z",
  "updated_at": "2026-02-09T17:05:00Z",
  "deleted_at": null
}
```

---

## Lifecycle States

### 1. Uploaded (Pending Processing)

```yaml
state: "uploaded"
processing_status: "pending"
capabilities:
  - File stored in object storage
  - Metadata extracted from file
  - Awaiting thumbnail generation
  - Awaiting AI analysis
transitions:
  - start_processing -> Processing
```

### 2. Processing

```yaml
state: "processing"
processing_status: "processing"
operations:
  - Thumbnail generation
  - Hash computation
  - AI label detection
  - Face recognition
  - OCR (if applicable)
transitions:
  - complete -> Active
  - error -> Failed
```

### 3. Active (Fully Processed)

```yaml
state: "active"
processing_status: "completed"
capabilities:
  - Full searchability
  - Thumbnail available
  - AI analysis complete
  - Can be added to albums
  - Can be shared
transitions:
  - delete -> Deleted
  - reprocess -> Processing
```

### 4. Failed (Processing Error)

```yaml
state: "failed"
processing_status: "failed"
behavior:
  - File preserved
  - Original metadata available
  - No thumbnail or AI data
  - Retry processing available
transitions:
  - retry -> Processing
  - delete -> Deleted
```

### 5. Deleted (Soft Delete)

```yaml
state: "deleted"
deleted_at: not null
behavior:
  - File moved to trash
  - 30-day retention
  - Removed from albums
  - Not visible in UI
transitions:
  - restore -> Active
  - timeout (30 days) -> Hard Deleted
```

---

## Notes for Implementers

### Performance Optimization

1. **Indexing Strategy**
   - Composite index on (user_id, media_type) for filtered lists
   - Index on taken_at for timeline views
   - GIN index on tags JSONB for tag searches
   - Spatial index on (latitude, longitude) for map views

2. **Caching**
   - Cache thumbnails with CDN (CloudFront, etc.)
   - Cache media metadata (5 minute TTL)
   - Cache search results (1 minute TTL)

3. **Async Processing**
   - Use job queue (Celery, RQ) for processing pipeline
   - Process uploads asynchronously
   - Return immediately with pending status

### Storage Optimization

1. **Deduplication**
   ```python
   # Check if file already exists for user
   existing = Media.query.filter_by(
       user_id=user_id,
       hash_sha256=computed_hash
   ).first()

   if existing:
       # Create new Media record pointing to same file
       # Don't upload duplicate file
   ```

2. **Cleanup Jobs**
   - Delete files after 30 days in trash
   - Clean orphaned files (no database record)
   - Compress old thumbnails

---

**Status:** Active - Core Media Type
**Version:** 1.0
**Authority:** 0.0.2 - Media Types
**Created:** 2026-02-09
**Owner:** Hypernet Core (0.*)
