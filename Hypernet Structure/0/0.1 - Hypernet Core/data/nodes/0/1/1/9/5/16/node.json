{
  "address": "0.1.1.9.5.16",
  "type_address": null,
  "data": {
    "name": "web_pages.py",
    "type": "file",
    "extension": ".py",
    "path": "C:\\Hypernet\\Hypernet Structure\\0\\0.1 - Hypernet Core\\0.1.1 - Core System\\app\\routes\\web_pages.py",
    "size": 8344,
    "content": "\"\"\"\nWeb Pages Routes\n\nEndpoints for managing saved web pages and articles.\n\"\"\"\n\nfrom fastapi import APIRouter, Depends, HTTPException, status, Query\nfrom sqlalchemy.orm import Session\nfrom sqlalchemy import and_, or_\nfrom pydantic import BaseModel, Field\nfrom datetime import datetime\nfrom typing import Optional, List\nfrom uuid import UUID\n\nfrom app.core.database import get_db\nfrom app.core.dependencies import get_current_user\nfrom app.models.user import User\nfrom app.models.web_page import WebPage\n\nrouter = APIRouter()\n\n\n# Request/Response Models\nclass WebPageCreate(BaseModel):\n    \"\"\"Web page creation request\"\"\"\n    url: str = Field(..., max_length=2048)\n    title: str = Field(..., max_length=500)\n    html_content: Optional[str] = None\n    text_content: Optional[str] = None\n    screenshot_id: Optional[UUID] = None\n    author: Optional[str] = Field(None, max_length=200)\n    published_at: Optional[datetime] = None\n    site_name: Optional[str] = Field(None, max_length=200)\n    description: Optional[str] = None\n    archive_path: Optional[str] = Field(None, max_length=512)\n\n\nclass WebPageUpdate(BaseModel):\n    \"\"\"Web page update request\"\"\"\n    title: Optional[str] = Field(None, max_length=500)\n    html_content: Optional[str] = None\n    text_content: Optional[str] = None\n    screenshot_id: Optional[UUID] = None\n    author: Optional[str] = Field(None, max_length=200)\n    published_at: Optional[datetime] = None\n    site_name: Optional[str] = Field(None, max_length=200)\n    description: Optional[str] = None\n    archive_path: Optional[str] = Field(None, max_length=512)\n\n\nclass WebPageResponse(BaseModel):\n    \"\"\"Web page response\"\"\"\n    id: str\n    user_id: str\n    url: str\n    title: str\n    html_content: Optional[str]\n    text_content: Optional[str]\n    screenshot_id: Optional[str]\n    author: Optional[str]\n    published_at: Optional[datetime]\n    site_name: Optional[str]\n    description: Optional[str]\n    archive_path: Optional[str]\n    saved_at: datetime\n    created_at: datetime\n\n    class Config:\n        from_attributes = True\n\n\nclass WebPageListResponse(BaseModel):\n    \"\"\"Paginated web page list response\"\"\"\n    items: List[WebPageResponse]\n    total: int\n    page: int\n    page_size: int\n\n\n@router.post(\"\", response_model=WebPageResponse, status_code=status.HTTP_201_CREATED)\nasync def create_web_page(\n    request: WebPageCreate,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user)\n):\n    \"\"\"\n    Save a new web page.\n\n    - **url**: Page URL (required)\n    - **title**: Page title (required)\n    - **html_content**: Full HTML content\n    - **text_content**: Extracted text content\n    - **screenshot_id**: ID of screenshot media\n    - **author**: Article author\n    - **published_at**: Publication date\n    - **site_name**: Website name\n    - **description**: Page description/summary\n    \"\"\"\n    web_page = WebPage(\n        user_id=current_user.id,\n        url=request.url,\n        title=request.title,\n        html_content=request.html_content,\n        text_content=request.text_content,\n        screenshot_id=request.screenshot_id,\n        author=request.author,\n        published_at=request.published_at,\n        site_name=request.site_name,\n        description=request.description,\n        archive_path=request.archive_path,\n        saved_at=datetime.utcnow()\n    )\n\n    db.add(web_page)\n    db.commit()\n    db.refresh(web_page)\n\n    return WebPageResponse.model_validate(web_page)\n\n\n@router.get(\"\", response_model=WebPageListResponse)\nasync def list_web_pages(\n    site_name: Optional[str] = Query(None, description=\"Filter by site name\"),\n    author: Optional[str] = Query(None, description=\"Filter by author\"),\n    search: Optional[str] = Query(None, description=\"Search in title, description, text\"),\n    page: int = Query(1, ge=1),\n    page_size: int = Query(50, ge=1, le=100),\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user)\n):\n    \"\"\"\n    List saved web pages for the current user.\n\n    Supports:\n    - Filter by site_name\n    - Filter by author\n    - Full-text search in title, description, text_content\n    - Pagination\n\n    Results ordered by saved_at descending (newest first).\n    \"\"\"\n    query = db.query(WebPage).filter(\n        and_(\n            WebPage.user_id == current_user.id,\n            WebPage.deleted_at.is_(None)\n        )\n    )\n\n    if site_name:\n        query = query.filter(WebPage.site_name.ilike(f\"%{site_name}%\"))\n\n    if author:\n        query = query.filter(WebPage.author.ilike(f\"%{author}%\"))\n\n    if search:\n        search_pattern = f\"%{search}%\"\n        query = query.filter(\n            or_(\n                WebPage.title.ilike(search_pattern),\n                WebPage.description.ilike(search_pattern),\n                WebPage.text_content.ilike(search_pattern)\n            )\n        )\n\n    total = query.count()\n\n    offset = (page - 1) * page_size\n    items = query.order_by(WebPage.saved_at.desc()).offset(offset).limit(page_size).all()\n\n    return WebPageListResponse(\n        items=[WebPageResponse.model_validate(item) for item in items],\n        total=total,\n        page=page,\n        page_size=page_size\n    )\n\n\n@router.get(\"/{page_id}\", response_model=WebPageResponse)\nasync def get_web_page(\n    page_id: UUID,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user)\n):\n    \"\"\"Get a specific saved web page by ID.\"\"\"\n    web_page = db.query(WebPage).filter(\n        and_(\n            WebPage.id == page_id,\n            WebPage.user_id == current_user.id,\n            WebPage.deleted_at.is_(None)\n        )\n    ).first()\n\n    if not web_page:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Web page not found\"\n        )\n\n    return WebPageResponse.model_validate(web_page)\n\n\n@router.patch(\"/{page_id}\", response_model=WebPageResponse)\nasync def update_web_page(\n    page_id: UUID,\n    request: WebPageUpdate,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user)\n):\n    \"\"\"\n    Update web page metadata.\n\n    All fields are optional. Only provided fields will be updated.\n    \"\"\"\n    web_page = db.query(WebPage).filter(\n        and_(\n            WebPage.id == page_id,\n            WebPage.user_id == current_user.id,\n            WebPage.deleted_at.is_(None)\n        )\n    ).first()\n\n    if not web_page:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Web page not found\"\n        )\n\n    if request.title is not None:\n        web_page.title = request.title\n    if request.html_content is not None:\n        web_page.html_content = request.html_content\n    if request.text_content is not None:\n        web_page.text_content = request.text_content\n    if request.screenshot_id is not None:\n        web_page.screenshot_id = request.screenshot_id\n    if request.author is not None:\n        web_page.author = request.author\n    if request.published_at is not None:\n        web_page.published_at = request.published_at\n    if request.site_name is not None:\n        web_page.site_name = request.site_name\n    if request.description is not None:\n        web_page.description = request.description\n    if request.archive_path is not None:\n        web_page.archive_path = request.archive_path\n\n    db.commit()\n    db.refresh(web_page)\n\n    return WebPageResponse.model_validate(web_page)\n\n\n@router.delete(\"/{page_id}\", status_code=status.HTTP_204_NO_CONTENT)\nasync def delete_web_page(\n    page_id: UUID,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user)\n):\n    \"\"\"Soft delete a saved web page.\"\"\"\n    web_page = db.query(WebPage).filter(\n        and_(\n            WebPage.id == page_id,\n            WebPage.user_id == current_user.id,\n            WebPage.deleted_at.is_(None)\n        )\n    ).first()\n\n    if not web_page:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Web page not found\"\n        )\n\n    web_page.soft_delete()\n    db.commit()\n\n    return None\n"
  },
  "created_at": "2026-02-17T01:21:59.066196+00:00",
  "updated_at": "2026-02-17T01:21:59.066196+00:00",
  "deleted_at": null,
  "source_type": "import",
  "source_id": "file:web_pages.py"
}