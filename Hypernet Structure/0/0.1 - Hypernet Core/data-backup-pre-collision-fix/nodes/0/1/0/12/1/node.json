{
  "address": "0.1.0.12.1",
  "type_address": null,
  "data": {
    "name": "01-Database-Schema.md",
    "type": "file",
    "extension": ".md",
    "path": "C:\\Hypernet\\Hypernet Structure\\0\\0.1 - Hypernet Core\\0.1.0 - Planning & Documentation\\Database-Design\\01-Database-Schema.md",
    "size": 18778,
    "content": "# Hypernet Core - Database Schema\n\n**Version:** 0.1.0\n**Database:** PostgreSQL 15+\n**ORM:** SQLAlchemy 2.0+\n**Migrations:** Alembic\n**Last Updated:** 2026-02-03\n\n---\n\n## Overview\n\nThis document defines the PostgreSQL database schema for Hypernet Core 0.1, implementing the object model and link model specifications.\n\n### Design Principles\n\n1. **Normalized** - Minimize redundancy, maintain data integrity\n2. **Performant** - Indexes on frequently queried fields\n3. **Extensible** - JSONB metadata for flexibility\n4. **Secure** - Row-level security, encrypted sensitive fields\n5. **Auditable** - Timestamps and soft deletes on all tables\n\n---\n\n## Tables\n\n### 1. users\n\nUser accounts and authentication.\n\n```sql\nCREATE TABLE users (\n    -- Identity\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n\n    -- Authentication\n    email VARCHAR(255) NOT NULL UNIQUE,\n    password_hash VARCHAR(255) NOT NULL,\n    email_verified BOOLEAN NOT NULL DEFAULT FALSE,\n\n    -- Profile\n    display_name VARCHAR(100),\n    avatar_url VARCHAR(1024),\n\n    -- Account Status\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    is_admin BOOLEAN NOT NULL DEFAULT FALSE,\n\n    -- Timestamps\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    last_login_at TIMESTAMP WITH TIME ZONE,\n    deleted_at TIMESTAMP WITH TIME ZONE,\n\n    -- Storage Quotas\n    storage_used BIGINT NOT NULL DEFAULT 0,\n    storage_quota BIGINT NOT NULL DEFAULT 10737418240, -- 10 GB\n\n    -- Extensibility\n    metadata JSONB NOT NULL DEFAULT '{}'::jsonb\n);\n\n-- Indexes\nCREATE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;\nCREATE INDEX idx_users_created_at ON users(created_at);\n\n-- Trigger for updated_at\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER users_updated_at BEFORE UPDATE ON users\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n```\n\n---\n\n### 2. media\n\nPhotos, videos, and other media files.\n\n```sql\nCREATE TABLE media (\n    -- Identity\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n\n    -- Ownership\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n\n    -- Basic Info\n    filename VARCHAR(255) NOT NULL,\n    media_type VARCHAR(50) NOT NULL, -- 'photo', 'video', 'document', 'other'\n    mime_type VARCHAR(100) NOT NULL,\n\n    -- File Information\n    size BIGINT NOT NULL,\n    width INTEGER,\n    height INTEGER,\n    duration DOUBLE PRECISION, -- seconds (for videos)\n\n    -- Storage\n    file_path VARCHAR(1024) NOT NULL,\n    thumbnail_path VARCHAR(1024),\n    hash VARCHAR(64) NOT NULL, -- SHA-256\n\n    -- Dates and Location\n    taken_at TIMESTAMP WITH TIME ZONE,\n    latitude DOUBLE PRECISION,\n    longitude DOUBLE PRECISION,\n\n    -- Source Tracking\n    source_type VARCHAR(50), -- 'upload', 'integration', 'import'\n    source_id VARCHAR(255),\n\n    -- Processing Status\n    processing_status VARCHAR(50) NOT NULL DEFAULT 'pending', -- 'pending', 'processing', 'complete', 'failed'\n    thumbnail_generated BOOLEAN NOT NULL DEFAULT FALSE,\n    metadata_extracted BOOLEAN NOT NULL DEFAULT FALSE,\n\n    -- Timestamps\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    deleted_at TIMESTAMP WITH TIME ZONE,\n\n    -- Extensibility\n    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,\n\n    -- Constraints\n    CONSTRAINT chk_media_type CHECK (media_type IN ('photo', 'video', 'document', 'other')),\n    CONSTRAINT chk_processing_status CHECK (processing_status IN ('pending', 'processing', 'complete', 'failed')),\n    CONSTRAINT chk_latitude CHECK (latitude IS NULL OR (latitude >= -90 AND latitude <= 90)),\n    CONSTRAINT chk_longitude CHECK (longitude IS NULL OR (longitude >= -180 AND longitude <= 180))\n);\n\n-- Indexes\nCREATE INDEX idx_media_user_id ON media(user_id) WHERE deleted_at IS NULL;\nCREATE INDEX idx_media_hash ON media(hash);\nCREATE INDEX idx_media_taken_at ON media(taken_at) WHERE deleted_at IS NULL;\nCREATE INDEX idx_media_media_type ON media(media_type) WHERE deleted_at IS NULL;\nCREATE INDEX idx_media_source ON media(user_id, source_type, source_id) WHERE deleted_at IS NULL;\n\n-- GIN index for metadata (allows querying inside JSONB)\nCREATE INDEX idx_media_metadata ON media USING GIN(metadata);\n\n-- Trigger for updated_at\nCREATE TRIGGER media_updated_at BEFORE UPDATE ON media\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n```\n\n---\n\n### 3. albums\n\nCollections of media.\n\n```sql\nCREATE TABLE albums (\n    -- Identity\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n\n    -- Ownership\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n\n    -- Basic Info\n    name VARCHAR(200) NOT NULL,\n    description TEXT,\n\n    -- Display\n    cover_media_id UUID REFERENCES media(id) ON DELETE SET NULL,\n    sort_order VARCHAR(50) NOT NULL DEFAULT 'date_desc', -- 'date_asc', 'date_desc', 'manual'\n\n    -- Counts (denormalized for performance)\n    media_count INTEGER NOT NULL DEFAULT 0,\n\n    -- Privacy (future use)\n    visibility VARCHAR(50) NOT NULL DEFAULT 'private', -- 'private', 'unlisted', 'public'\n\n    -- Timestamps\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    deleted_at TIMESTAMP WITH TIME ZONE,\n\n    -- Source Tracking\n    source_type VARCHAR(50),\n    source_id VARCHAR(255),\n\n    -- Extensibility\n    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,\n\n    -- Constraints\n    CONSTRAINT chk_sort_order CHECK (sort_order IN ('date_asc', 'date_desc', 'manual')),\n    CONSTRAINT chk_visibility CHECK (visibility IN ('private', 'unlisted', 'public')),\n    CONSTRAINT chk_media_count CHECK (media_count >= 0)\n);\n\n-- Indexes\nCREATE INDEX idx_albums_user_id ON albums(user_id) WHERE deleted_at IS NULL;\nCREATE INDEX idx_albums_name ON albums(user_id, name) WHERE deleted_at IS NULL;\n\n-- Trigger for updated_at\nCREATE TRIGGER albums_updated_at BEFORE UPDATE ON albums\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n```\n\n---\n\n### 4. integrations\n\nConnected external services.\n\n```sql\nCREATE TABLE integrations (\n    -- Identity\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n\n    -- Ownership\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n\n    -- Integration Details\n    integration_type VARCHAR(50) NOT NULL, -- 'instagram', 'google_photos', 'facebook', etc.\n    integration_name VARCHAR(200) NOT NULL,\n\n    -- Status\n    status VARCHAR(50) NOT NULL DEFAULT 'pending', -- 'connected', 'disconnected', 'error', 'pending'\n    is_enabled BOOLEAN NOT NULL DEFAULT TRUE,\n\n    -- OAuth2 (encrypted in separate table - see integration_secrets)\n    token_expires_at TIMESTAMP WITH TIME ZONE,\n\n    -- Sync State\n    last_sync_at TIMESTAMP WITH TIME ZONE,\n    last_sync_status VARCHAR(50), -- 'success', 'partial', 'failed'\n    sync_cursor TEXT, -- Pagination cursor for incremental sync\n\n    -- Statistics\n    items_synced INTEGER NOT NULL DEFAULT 0,\n\n    -- Timestamps\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    deleted_at TIMESTAMP WITH TIME ZONE,\n\n    -- Source Tracking\n    source_type VARCHAR(50),\n    source_id VARCHAR(255),\n\n    -- Extensibility\n    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,\n\n    -- Constraints\n    CONSTRAINT chk_integration_status CHECK (status IN ('connected', 'disconnected', 'error', 'pending')),\n    CONSTRAINT chk_sync_status CHECK (last_sync_status IS NULL OR last_sync_status IN ('success', 'partial', 'failed')),\n    CONSTRAINT chk_items_synced CHECK (items_synced >= 0)\n);\n\n-- Indexes\nCREATE INDEX idx_integrations_user_id ON integrations(user_id) WHERE deleted_at IS NULL;\nCREATE INDEX idx_integrations_type ON integrations(user_id, integration_type) WHERE deleted_at IS NULL;\nCREATE INDEX idx_integrations_status ON integrations(status) WHERE deleted_at IS NULL;\n\n-- Trigger for updated_at\nCREATE TRIGGER integrations_updated_at BEFORE UPDATE ON integrations\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n```\n\n---\n\n### 5. integration_secrets\n\nOAuth tokens and secrets (encrypted at rest).\n\n**Note:** Stored separately for additional security. Can be encrypted at database level using pgcrypto.\n\n```sql\nCREATE TABLE integration_secrets (\n    -- Identity\n    integration_id UUID PRIMARY KEY REFERENCES integrations(id) ON DELETE CASCADE,\n\n    -- OAuth2 Tokens (should be encrypted)\n    access_token TEXT,\n    refresh_token TEXT,\n\n    -- Timestamps\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()\n);\n\n-- No indexes needed (always queried by integration_id primary key)\n\n-- Trigger for updated_at\nCREATE TRIGGER integration_secrets_updated_at BEFORE UPDATE ON integration_secrets\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n```\n\n---\n\n### 6. links\n\nRelationships between objects (first-class links).\n\n```sql\nCREATE TABLE links (\n    -- Identity\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n\n    -- Ownership\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n\n    -- Link Endpoints\n    from_object_id UUID NOT NULL,\n    from_object_type VARCHAR(50) NOT NULL,\n    to_object_id UUID NOT NULL,\n    to_object_type VARCHAR(50) NOT NULL,\n\n    -- Link Type\n    link_type VARCHAR(50) NOT NULL, -- 'contains', 'source', 'duplicate_of', 'variant_of'\n\n    -- Link Properties\n    strength DOUBLE PRECISION NOT NULL DEFAULT 1.0,\n    is_bidirectional BOOLEAN NOT NULL DEFAULT FALSE,\n\n    -- Ordering (for ordered relationships like album -> photos)\n    sort_order INTEGER,\n\n    -- Timestamps\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    deleted_at TIMESTAMP WITH TIME ZONE,\n\n    -- Source Tracking\n    source_type VARCHAR(50),\n    source_id VARCHAR(255),\n\n    -- Extensibility\n    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,\n\n    -- Constraints\n    CONSTRAINT chk_link_type CHECK (link_type IN ('contains', 'source', 'duplicate_of', 'variant_of', 'related_to')),\n    CONSTRAINT chk_strength CHECK (strength >= 0.0 AND strength <= 1.0),\n    CONSTRAINT chk_not_self_link CHECK (from_object_id != to_object_id OR from_object_type != to_object_type)\n);\n\n-- Indexes\nCREATE INDEX idx_links_user_id ON links(user_id) WHERE deleted_at IS NULL;\nCREATE INDEX idx_links_from ON links(from_object_id, link_type) WHERE deleted_at IS NULL;\nCREATE INDEX idx_links_to ON links(to_object_id, link_type) WHERE deleted_at IS NULL;\nCREATE INDEX idx_links_ordered ON links(from_object_id, sort_order) WHERE deleted_at IS NULL AND sort_order IS NOT NULL;\n\n-- Unique constraint: No duplicate links\nCREATE UNIQUE INDEX idx_links_unique ON links(from_object_id, to_object_id, link_type) WHERE deleted_at IS NULL;\n\n-- Trigger for updated_at\nCREATE TRIGGER links_updated_at BEFORE UPDATE ON links\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n```\n\n---\n\n## Additional Tables (Future / Optional)\n\n### 7. refresh_tokens (for JWT refresh token management)\n\n```sql\nCREATE TABLE refresh_tokens (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    token_hash VARCHAR(64) NOT NULL UNIQUE, -- SHA-256 of token\n    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n    revoked_at TIMESTAMP WITH TIME ZONE\n);\n\nCREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);\nCREATE INDEX idx_refresh_tokens_hash ON refresh_tokens(token_hash) WHERE revoked_at IS NULL;\n```\n\n---\n\n### 8. audit_log (security audit trail)\n\n```sql\nCREATE TABLE audit_log (\n    id BIGSERIAL PRIMARY KEY,\n    user_id UUID REFERENCES users(id) ON DELETE SET NULL,\n    action VARCHAR(100) NOT NULL, -- 'login', 'upload', 'delete', etc.\n    resource_type VARCHAR(50), -- 'media', 'album', etc.\n    resource_id UUID,\n    ip_address INET,\n    user_agent TEXT,\n    details JSONB,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_audit_log_user_id ON audit_log(user_id);\nCREATE INDEX idx_audit_log_created_at ON audit_log(created_at);\nCREATE INDEX idx_audit_log_action ON audit_log(action);\n```\n\n---\n\n## Views\n\n### active_media (media not deleted)\n\n```sql\nCREATE VIEW active_media AS\nSELECT * FROM media WHERE deleted_at IS NULL;\n```\n\n### active_albums (albums not deleted)\n\n```sql\nCREATE VIEW active_albums AS\nSELECT * FROM albums WHERE deleted_at IS NULL;\n```\n\n### active_links (links not deleted)\n\n```sql\nCREATE VIEW active_links AS\nSELECT * FROM links WHERE deleted_at IS NULL;\n```\n\n---\n\n## Common Queries\n\n### Get all media for user\n\n```sql\nSELECT * FROM media\nWHERE user_id = $1 AND deleted_at IS NULL\nORDER BY taken_at DESC NULLS LAST\nLIMIT 50 OFFSET 0;\n```\n\n### Get media in album (with links)\n\n```sql\nSELECT m.*, l.sort_order, l.id AS link_id\nFROM media m\nJOIN links l ON l.to_object_id = m.id\nWHERE l.from_object_id = $1  -- album_id\n  AND l.from_object_type = 'album'\n  AND l.to_object_type = 'media'\n  AND l.link_type = 'contains'\n  AND l.deleted_at IS NULL\n  AND m.deleted_at IS NULL\nORDER BY l.sort_order NULLS LAST;\n```\n\n### Get source integration for media\n\n```sql\nSELECT i.*\nFROM integrations i\nJOIN links l ON l.to_object_id = i.id\nWHERE l.from_object_id = $1  -- media_id\n  AND l.from_object_type = 'media'\n  AND l.to_object_type = 'integration'\n  AND l.link_type = 'source'\n  AND l.deleted_at IS NULL\n  AND i.deleted_at IS NULL;\n```\n\n### Find duplicates of media\n\n```sql\nSELECT m.*\nFROM media m\nJOIN links l ON l.to_object_id = m.id\nWHERE l.from_object_id = $1  -- media_id\n  AND l.from_object_type = 'media'\n  AND l.to_object_type = 'media'\n  AND l.link_type = 'duplicate_of'\n  AND l.deleted_at IS NULL\n  AND m.deleted_at IS NULL;\n```\n\n### Check for existing import (deduplication)\n\n```sql\nSELECT m.id\nFROM media m\nJOIN links l ON l.from_object_id = m.id\nWHERE m.user_id = $1\n  AND l.to_object_id = $2  -- integration_id\n  AND l.link_type = 'source'\n  AND m.metadata->>'external_id' = $3  -- external media ID\n  AND m.deleted_at IS NULL\n  AND l.deleted_at IS NULL\nLIMIT 1;\n```\n\n---\n\n## Performance Considerations\n\n### Indexes\n\n**Users:**\n- `email` - Fast login lookups\n- `created_at` - User statistics\n\n**Media:**\n- `user_id` - Fast user media queries\n- `hash` - Deduplication\n- `taken_at` - Timeline views\n- `media_type` - Filter by type\n- `(user_id, source_type, source_id)` - Sync deduplication\n\n**Links:**\n- `(from_object_id, link_type)` - Fast \"get all links from X\"\n- `(to_object_id, link_type)` - Fast \"get all links to X\"\n- `(from_object_id, to_object_id, link_type)` - Prevent duplicates, fast lookups\n\n### Query Optimization\n\n1. **Always filter by deleted_at IS NULL** in WHERE clauses\n2. **Use LIMIT** for large result sets\n3. **Index JSONB fields** selectively (GIN indexes)\n4. **Denormalize counts** (e.g., `album.media_count`) for performance\n5. **Use partial indexes** (WHERE deleted_at IS NULL) to exclude soft-deleted rows\n\n---\n\n## Data Integrity\n\n### Foreign Keys\n\n- All `user_id` columns reference `users(id)` with `ON DELETE CASCADE`\n- Deleting user deletes all their data\n- `cover_media_id` uses `ON DELETE SET NULL` (album survives if cover deleted)\n\n### Constraints\n\n- `CHECK` constraints for enum-like fields (media_type, status, etc.)\n- `CHECK` constraints for valid ranges (latitude, longitude, strength)\n- `UNIQUE` constraints prevent duplicates (email, links)\n\n### Soft Deletes\n\n- `deleted_at` timestamp instead of hard delete\n- Partial indexes exclude soft-deleted rows\n- Can be restored by setting `deleted_at = NULL`\n- Hard delete after retention period (cron job)\n\n---\n\n## Security\n\n### Encryption at Rest\n\n**Database-level encryption (LUKS2):**\n- Entire `/data` partition encrypted\n- Protects all tables\n\n**Column-level encryption (optional):**\n```sql\n-- Using pgcrypto extension\nCREATE EXTENSION IF NOT EXISTS pgcrypto;\n\n-- Encrypt access_token before insert\nINSERT INTO integration_secrets (integration_id, access_token)\nVALUES ($1, pgp_sym_encrypt($2, 'encryption-key'));\n\n-- Decrypt on read\nSELECT pgp_sym_decrypt(access_token::bytea, 'encryption-key') AS access_token\nFROM integration_secrets WHERE integration_id = $1;\n```\n\n### Row-Level Security (RLS)\n\n**Enable RLS on tables:**\n```sql\nALTER TABLE media ENABLE ROW LEVEL SECURITY;\n\n-- Policy: Users can only see their own media\nCREATE POLICY media_user_isolation ON media\n    FOR ALL\n    USING (user_id = current_setting('app.current_user_id')::uuid);\n```\n\n**Set user context in application:**\n```sql\nSET app.current_user_id = 'user-uuid';\n```\n\n---\n\n## Migration Strategy\n\n### Initial Migration (0001_initial.sql)\n\nSee `02-Initial-Migration.sql`\n\n### Future Migrations\n\n```sql\n-- Example: Add new column\nALTER TABLE media ADD COLUMN ai_tags TEXT[];\n\n-- Example: Create new index\nCREATE INDEX idx_media_ai_tags ON media USING GIN(ai_tags);\n\n-- Example: Add new link type\nALTER TABLE links DROP CONSTRAINT chk_link_type;\nALTER TABLE links ADD CONSTRAINT chk_link_type\n    CHECK (link_type IN ('contains', 'source', 'duplicate_of', 'variant_of', 'tagged_with'));\n```\n\n---\n\n## Backup and Maintenance\n\n### Daily Backups\n\n```bash\n# Backup database\npg_dump -U hypernet -d hypernet -F c -f /backup/db/hypernet-$(date +%Y%m%d).dump\n\n# Restore\npg_restore -U hypernet -d hypernet /backup/db/hypernet-20260203.dump\n```\n\n### Vacuum and Analyze\n\n```sql\n-- Regular maintenance (run weekly)\nVACUUM ANALYZE;\n\n-- Per table\nVACUUM ANALYZE media;\n```\n\n### Clean up soft-deleted rows\n\n```sql\n-- Delete media soft-deleted > 30 days ago\nDELETE FROM media\nWHERE deleted_at IS NOT NULL\n  AND deleted_at < NOW() - INTERVAL '30 days';\n```\n\n---\n\n## Next Steps\n\n1. \u2705 Review schema design\n2. \u23f3 Create initial migration SQL\n3. \u23f3 Implement SQLAlchemy models\n4. \u23f3 Test schema with sample data\n5. \u23f3 Optimize indexes based on query patterns\n\n---\n\n**Status:** Ready for implementation\n**Next:** `02-Initial-Migration.sql` - SQL script to create all tables\n"
  },
  "created_at": "2026-02-15T11:53:48.225562+00:00",
  "updated_at": "2026-02-15T11:53:48.225562+00:00",
  "deleted_at": null,
  "source_type": "import",
  "source_id": "file:01-Database-Schema.md"
}